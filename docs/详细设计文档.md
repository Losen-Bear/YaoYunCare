# 微信小程序服务端详细设计（Koa2 简化版｜虚拟人物预制素材）

版本：v1.1（适配《概要设计1.0.md》虚拟人物预制素材方案）  
设计目标：支撑大赛演示闭环“症状采集 → 体质判定 → 食谱推荐 → 播放预制素材”，强调可落地与低复杂度。

## 1. 总体说明
- 技术栈：Node.js + Koa2 + mysql2（原生 SQL）  
- 前端播放：小程序原生 video 组件（支持外链/本地视频）  
- 部署方式：本地 Node 运行 + 小程序调试；零云资源、零鉴权
- 数据来源：规则与食谱存于 MySQL；预制素材链接与食谱绑定

## 2. 分层与模块
- 接入层：koa2-cors（跨域）、koa-bodyparser（JSON 解析）、koa-router（路由）
- 控制器：constitutionController、recipeController
- 服务层：constitutionService（规则判定）、recipeService（食谱+素材查询）
- 存储层：MySQL（constitution、symptom_rule、recipe 三张核心表）
- 外部素材：B站/抖音外链或本地视频文件（由前端直接播放）

## 3. 详细设计与核心代码
### 3.1 启动与中间件
```javascript
// app.js
const Koa = require('koa');
const router = require('./routes');
const bodyParser = require('koa-bodyparser');
const cors = require('koa2-cors');

const app = new Koa();
app.use(cors({ origin: '*', credentials: true }));
app.use(bodyParser({ enableTypes: ['json'] }));
app.use(router.routes()).use(router.allowedMethods());

const port = 3000;
app.listen(port, () => {
  console.log(`服务端启动成功！地址：http://localhost:${port}`);
});
```

### 3.2 体质判定服务
规则来源于数据库 symptom_rule 表（也可写死在 JSON）。根据“症状命中计数”选择匹配度最高的体质。
```javascript
// service/constitutionService.js
async function judgeConstitution(symptoms) {
  // 查询规则 → 计数命中 → 取最大值 → 返回 mainConstitution 与 matchDetail
}
module.exports = { judgeConstitution };
```

### 3.3 食谱+虚拟人物素材服务（合并）
查询食谱时直接返回预制素材链接 video_url；前端收到后用原生 video 播放。
```javascript
// service/recipeService.js
async function getRecipeByConstitution(constitution) {
  // SELECT id, name, ingredients, steps, video_url FROM recipe WHERE constitution = ?
  // JSON 字段转数组后返回
}
async function getMaterialByRecipeId(recipeId) {
  // SELECT video_url FROM recipe WHERE id = ?
}
module.exports = { getRecipeByConstitution, getMaterialByRecipeId };
```

### 3.4 控制器与路由
```javascript
// controller/recipeController.js
async function getRecipe(ctx) { /* 读取 constitution → 返回食谱+素材 */ }
async function getMaterial(ctx) { /* 读取 recipeId → 返回 videoUrl */ }
module.exports = { getRecipe, getMaterial };
```
```javascript
// routes/index.js
router.post('/api/constitution/judge', constitutionController.judge);
router.get('/api/recipe/list', recipeController.getRecipe);
router.get('/api/recipe/material', recipeController.getMaterial);
router.get('/api/health/check', async (ctx) => { ctx.body = { code: 200, message: '服务端正常运行' }; });
```

## 4. 数据库设计
### 4.1 连接配置
```javascript
// config/db.js
const mysql = require('mysql2/promise');
module.exports = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: '你的数据库密码',
  database: 'constitution_recipe',
  waitForConnections: true, connectionLimit: 10, queueLimit: 0
});
```
### 4.2 表结构与示例数据
```sql
CREATE TABLE IF NOT EXISTS constitution (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL COMMENT '体质名称'
);
CREATE TABLE IF NOT EXISTS symptom_rule (
  id INT PRIMARY KEY AUTO_INCREMENT,
  constitution_id INT,
  symptom_list JSON COMMENT '症状列表（JSON 字符串）'
);
CREATE TABLE IF NOT EXISTS recipe (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  constitution VARCHAR(50) NOT NULL,
  ingredients TEXT COMMENT 'JSON 字符串',
  steps TEXT COMMENT 'JSON 字符串',
  video_url VARCHAR(500) COMMENT '预制素材链接或本地路径'
);
-- 示例数据（可按需调整）
INSERT INTO constitution (name) VALUES ('阳虚质'), ('阴虚质'), ('气虚质'), ('平和质');
```

## 5. 交互时序
- 体质判定：小程序提交症状 → POST /api/constitution/judge → 返回 mainConstitution 与匹配详情
- 食谱与素材：小程序按体质拉取 → GET /api/recipe/list?constitution=xxx → 返回含 video_url 的食谱列表 → 原生 video 播放
- 可选素材直取：GET /api/recipe/material?recipeId=1 → 返回 videoUrl（便于单独播放）

## 6. 前端适配要点
- 使用原生 video 组件播放预制素材，示例：
```xml
<video src="{{recipe.video_url}}" controls style="width:100%;height:200px" show-center-play-btn></video>
```
- 数据结构：ingredients/steps 字段为数组；video_url 为可播放链接或本地路径

## 7. 错误处理与返回格式
- 统一返回：{ code, message, data }  
- 成功：code=200；参数错误：code=400；服务异常：code=500  
- 控制器内 try/catch 捕获异常并返回友好错误信息

## 8. 非功能与安全（大赛简化版）
- 无登录与鉴权；仅限本地/内网演示环境
- CORS 放开域名（本地调试方便）；避免写入任何密钥到仓库
- 不引入缓存/队列/监控等复杂组件，确保搭建成本低

## 9. 部署与调试步骤
1) 安装 Node.js 与 MySQL，创建数据库 constitution_recipe 并执行建表语句  
2) 填充食谱与素材链接（video_url 支持外链/B 站播放器或本地路径）  
3) 修改 config/db.js 密码；npm install → node app.js 启动服务  
4) 小程序勾选“不校验合法域名”，把请求地址改为局域网 IP:3000，验证素材播放

## 10. 虚拟人物预制素材管理
- 录制：手机即可；每个食谱 1–3 分钟讲解视频
- 命名：食谱名称 + 体质（如“当归生姜羊肉汤-阳虚质.mp4”）
- 存储：推荐第三方外链（B站/抖音，私密可见）；或本地视频（仅局域网）

## 11. 范围控制（明确不做）
- 会员/订单/支付、RBAC、缓存与限流、CI/CD、云上部署、日志与指标体系、A/B 与看板等均不纳入首版

本详细设计与《概要设计1.0.md》一致，聚焦演示闭环与虚拟人物预制素材的稳定播放与低成本实现。
