# 详细设计文档（SDD）

版本：v1.0  
依据：IEEE 1016、OWASP ASVS、十二要素应用

## 1. 后端分层设计
- API 层：路由与协议适配（FastAPI/Flask），参数校验（Pydantic），统一错误处理。
- Service 层：业务编排与事务控制（订单/权益/评估/推荐）。
- Domain 层：领域模型与规则（体质画像、菜谱、订单、会员）。
- Repository 层：ORM 映射与查询（SQLAlchemy），读写分离与分页。
- Infra 层：Redis（缓存/限流）、队列（Celery/RQ）、对象存储（COS/OSS）、日志与指标。

## 2. 领域模型（概要）
- User：用户实体，含 openId/unionId、会员态、偏好与最近评估。
- ConstitutionProfile：体质画像，包含各维度分值与主导标签、解释文本、雷达向量。
- Recipe：菜谱，食材/药材、功效标签、禁忌与做法、适配规则。
- Order：订单，商品类型、金额、状态、支付流水与回调日志。
- EventLog：埋点事件，事件名、页面、时间、扩展属性。

## 3. 数据库表设计（建议）
- users(id, open_id, union_id, nickname, avatar, gender, birthday, preferences_json, is_member, member_expire_at, created_at, updated_at)
- assessment_sessions(id, user_id, version, started_at, finished_at, status)
- assessment_results(id, session_id, user_id, constitution_label, scores_json, explain_text, radar_json, created_at)
- recipes(id, name, tags_json, effects_json, forbidden_json, steps_json, created_at, updated_at)
- ingredients(id, name, type, season, contraindications_json)
- recipe_ingredients(recipe_id, ingredient_id, amount, unit)
- orders(id, user_id, plan, amount, status, created_at, paid_at, closed_at)
- payments(id, order_id, channel, trade_no, notify_raw_json, success, created_at)
- rule_versions(id, type, version, content_json, created_at, is_active)
- event_logs(id, user_id, event_name, page, occurred_at, attributes_json)
- cms_assets(id, key, type, url, meta_json, created_at, updated_at)

主键均为自增或 UUID；常用外键加索引；时间字段使用 timestamp（UTC+8）。

## 4. 体质评估算法（规则版）
- 输入：问卷版本、作答集合（题目 id → 选项分值）。
- 处理：对每个体质维度聚合得分 → 归一化到 0–100 → 主导体质为得分最高维度。
- 解释：依据维度生成解释文本、Dos/Donts 列表；生成雷达向量用于图表展示。
- 约束：禁忌优先级高于推荐分；所有输出需可解释（包含得分来源）。

## 5. 推荐打分与禁忌
- 打分函数：score = w_constitution * fit + w_season * season_bonus + w_taste * taste_bonus - penalty
- 禁忌规则：若菜谱包含用户禁忌食材/药材 → 直接标记为不建议或降低适配度到阈值以下。
- 排序：按 score 降序；支持去重与多样化（同类菜谱不连续超过 2 个）。
- 缓存：用户体质画像与 Top-N 推荐缓存至 Redis，TTL 30–120 分钟，命中率目标 ≥ 60%。

## 6. 订单与支付流程
1) 创建订单：生成 orderId、校验商品与金额、写入待支付状态。  
2) 统一下单：调用微信支付，返回 payParams 给前端。  
3) 支付回调：验签 → 查找订单 → 幂等更新状态 → 写 payments → 开通会员权益。  
4) 失败处理：回调重试与重放；异常告警与人工介入。  
5) 对账：每日生成账单报表，与微信账单核对差异。

## 7. 鉴权与权限
- 登录：wx-login 换 token，token 过期支持刷新；敏感接口需用户态。
- 角色：user（默认）、operator（运营）、admin（管理员）。运营与管理员接口加 RBAC。
- 授权：接口装饰器校验权限与会员态；订单接口校验用户所有权。

## 8. 限流与防刷
- 维度：IP、用户、接口；令牌桶/漏桶实现；超限返回 429。
- 黑白名单：风控列表优先；异常行为进入观察或封禁。
- 幂等：订单、回调、重要操作必须具备幂等键。

## 9. 配置与环境
- 环境变量：DB_URL、REDIS_URL、COS_BUCKET、JWT_SECRET、PAY_APP_ID、PAY_SECRET 等。
- 多环境文件：dev/staging/prod；不将密钥写入代码库。
- 迁移：Alembic 维护数据库 schema 版本；回滚策略明确。

## 10. 日志与指标
- 日志字段：timestamp、level、traceId、userId、uri、status、duration、error、extra。
- 指标：请求耗时直方图、错误率、支付成功率、缓存命中率、推荐点击率。
- 告警：阈值与异常触发；支付失败/评估异常需及时通知。

## 11. 测试设计
- 单元测试：规则引擎、打分函数、支付幂等器、权限装饰器。
- 集成测试：API 端到端、数据库与缓存联动、支付回调沙箱。
- 性能测试：JMeter 压测主要接口（评估、推荐、支付下单），生成报告并入库。
- 覆盖率目标：≥ 70%；关键路径必须有测试。

## 12. 前端详细设计（小程序）
- 网络层：统一 request 封装，自动附带 token、重试与错误提示。
- 状态管理：全局 store 保存用户与会员态；页面局部状态存储。
- 组件：题卡、菜谱卡、雷达图、素材播放器、会员弹窗。
- 埋点：统一事件函数 track(event, attrs)；关键事件包括 login、assessment_submit、recommend_click、pay_success。
- 异常与降级：接口失败显示兜底内容；静态推荐与缓存回退。

## 13. 运维与部署细节
- 镜像：多阶段构建，减少体积；启动探针与健康检查。
- Nginx：反向代理、静态资源缓存、TLS 与 HSTS。
- 灰度：按用户/版本分流；蓝绿发布与自动回滚。
- 备份：数据库全量 + 增量；COS 版本化；定期恢复演练。

## 14. 安全控制点映射（ASVS 摘要）
- V2 认证：token 生命周期与刷新、密码不落地（仅微信登录）。
- V3 会话管理：短期 token、撤销与黑名单。
- V5 输入校验：参数校验与白名单；JSON schema 验证。
- V7 加密：静态与传输加密；密钥轮转与最小权限。
- V9 传输：HTTPS 强制、HSTS；回调验签。
- V13 日志：不记录敏感值；审计与告警。
- V14 配置：环境变量与密钥管理；无硬编码。
