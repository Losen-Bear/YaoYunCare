# 项目架构.md

版本：v1.0  
目标：定义仓库结构、工程规范、分支与发布流程，确保全周期符合行业规范

## 1. 仓库结构（Monorepo）
- miniprogram/：微信小程序源码（pages、components、services、utils、config）
- backend/：Python 服务（app、api、services、models、schemas、repositories、tasks、migrations、tests）
- ops/：部署与环境（Dockerfile、compose/k8s manifests、Nginx 配置）
- data-model/：题库与规则 JSON、模型清单与版本说明
- docs/：规范文档与接口协议
- .github/ 或 ci/：CI/CD 流水线（构建、测试、扫描与发布）

## 2. 技术栈与依赖
- 前端：微信小程序原生 + 组件库；TypeScript（可选）；统一请求与埋点。
- 后端：FastAPI/Flask + Uvicorn、SQLAlchemy、Pydantic、Alembic、Redis、Celery/RQ、HTTPX。
- 数据：MySQL、Redis、COS/OSS；Prometheus/Grafana 观测。

## 3. 编码与提交规范
- 代码风格：前端遵循 ESLint/Prettier（若启用 TS），后端遵循 PEP8 与 Ruff（建议）。
- commit message：Conventional Commits（feat/fix/docs/chore/test/build）。
- 分支策略：main 为稳定分支；develop 为集成分支；feature/*、hotfix/*；发布打 tag。
- 版本治理：语义化版本 SemVer（MAJOR.MINOR.PATCH），API 使用 /api/v1 路径。

## 4. CI/CD 流程
- 触发：PR 与 push 到 main/develop。
- 阶段：依赖安装 → lint/type-check → 单元与集成测试 → 安全扫描（依赖与镜像）→ 构建镜像 → 推送仓库 → 部署到 dev/staging。
- 门禁：测试通过、覆盖率 ≥ 70%、零高危漏洞、构建成功方可合并。
- 发布：staging 灰度验证后 promote 到 prod；含回滚脚本与方案。

## 5. 环境与配置管理
- 12-Factor：配置均由环境变量注入；机密由密钥管理系统存储与轮转。
- 多环境：dev/staging/prod；严格区分资源与参数；只读访问与最小权限。
- 证书与域名：HTTPS 必备；证书自动续期；域名备案。

## 6. 运行与运维
- 监控：接口耗时、错误率、支付成功率、推荐点击率、资源使用。
- 日志：结构化日志；按租户/用户/traceId 可检索；敏感信息脱敏。
- 告警：阈值告警、异常告警、回调失败告警；统一到运维群。
- 备份与灾备：数据库全量+增量、COS 版本化；双可用区部署与演练。

## 7. 安全与合规
- 合规：遵循《个人信息保护法》、等保 2.0、平台规则与支付合规。
- 安全基线：账户与鉴权、通信加密、输入校验、存储加密、权限与审计、最小化采集。
- 风险声明：显著展示免责声明与适用范围；避免医疗化承诺。

## 8. 测试策略
- 单元/集成/E2E：覆盖后端主要模块与前端关键流程。
- 性能压测：JMeter 对评估、推荐、下单接口进行压测，生成报告归档。
- 回归与灰度：每次发布进行自动化回归与灰度监控。

## 9. 里程碑与交付物
- M1：体质评估（规则版）、基础推荐、登录与埋点、文档与流水线。
- M2：会员与支付闭环、CMS、看板与 A/B。
- M3：模型化推荐与个性化、生态扩展与成本优化。
