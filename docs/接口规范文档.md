# 接口规范文档（API Spec）

版本：v1.0  
适用范围：小程序前端 ↔ Python 后端

## 1. 通用约定
- 基础路径：/api/v1
- 协议与格式：HTTPS、Content-Type: application/json; charset=utf-8
- 时间：ISO8601（UTC+8）；金额单位：分；布尔：true/false
- 认证：Authorization: Bearer <JWT>（短期）；刷新接口提供新的令牌
- 幂等：订单/回调以 orderId/requestId 实现幂等；重复请求返回相同结果
- 分页：query 参数 page（默认1）、pageSize（默认20，最大100）
- 排序：sort=field:asc|desc，多个字段逗号分隔
- 错误码：统一返回 code、message、details；HTTP 状态与业务码区分
- 速率限制：按 IP/用户维度限流，超限返回 429 Too Many Requests

## 2. 通用响应结构
```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```
- code：0 表示成功；非 0 为业务错误
- message：简要描述
- data：业务数据

## 3. 认证与会话
### POST /api/v1/auth/wx-login
- 描述：上送 code，后端调用 jscode2session，返回短期会话与用户标识
- 请求：
```json
{ "code": "wx_login_code" }
```
- 响应：
```json
{
  "code": 0,
  "data": {
    "token": "jwt-token",
    "expiresIn": 3600,
    "openId": "openid",
    "unionId": "unionid_optional",
    "isNewUser": true
  }
}
```

### POST /api/v1/auth/refresh
- 描述：刷新短期令牌
- 请求：无（使用刷新 cookie 或 header）
- 响应：同 wx-login 中 token 字段

## 4. 体质评估
### GET /api/v1/assessment/start
- 描述：拉取问卷元数据与题序（支持版本）
- 响应：
```json
{
  "code": 0,
  "data": {
    "version": "q-2026.02",
    "questions": [
      { "id": "q1", "type": "single", "text": "最近是否口干？", "options": ["从不","偶尔","经常"] }
    ]
  }
}
```

### POST /api/v1/assessment/submit
- 描述：提交作答，返回体质画像与解释
- 请求：
```json
{
  "version": "q-2026.02",
  "answers": [{ "id": "q1", "value": 2 }]
}
```
- 响应：
```json
{
  "code": 0,
  "data": {
    "constitution": "阴虚质",
    "scores": { "阴虚": 82, "气虚": 21, "湿热": 15 },
    "explain": "夜间易燥热，宜滋阴清热",
    "radar": [82,21,15,0,0,0,0,0,0],
    "dos": ["少辛辣烤炸","规律作息"],
    "donts": ["熬夜","过量酒精"]
  }
}
```

## 5. 推荐与菜谱
### GET /api/v1/recommendations
- 描述：按体质/偏好返回菜谱列表
- 参数：constitution、season、taste、page、pageSize
- 响应：
```json
{
  "code": 0,
  "data": {
    "items": [
      {
        "id": "r001",
        "name": "百合银耳羹",
        "tags": ["滋阴","清热"],
        "score": 92,
        "forbidden": ["寒凉体质慎用"]
      }
    ],
    "page": 1,
    "pageSize": 20,
    "total": 200
  }
}
```

### GET /api/v1/recipes/{id}
- 描述：菜谱详情
- 响应：
```json
{
  "code": 0,
  "data": {
    "id": "r001",
    "name": "百合银耳羹",
    "ingredients": [
      {"name":"百合","amount":"30g"},
      {"name":"银耳","amount":"20g"}
    ],
    "herbs": [{"name":"枸杞","amount":"10g"}],
    "steps": ["浸泡银耳","煮制"],
    "effects": ["滋阴","润燥"],
    "forbidden": ["寒凉体质慎用"]
  }
}
```

## 6. 会员与支付
### POST /api/v1/pay/orders
- 描述：创建会员订单
- 请求：
```json
{ "plan": "vip-year", "price": 19900 }
```
- 响应：
```json
{
  "code": 0,
  "data": {
    "orderId": "20260208-0001",
    "payParams": { "timeStamp":"", "nonceStr":"", "package":"", "signType":"", "paySign":"" }
  }
}
```

### POST /api/v1/pay/notify
- 描述：微信支付回调（服务端对服务端）
- 签名校验与幂等处理；响应按微信要求返回成功/失败

## 7. 内容与虚拟人物
### GET /api/v1/content/persona-lines
- 描述：虚拟人物台词与素材列表
- 响应：
```json
{
  "code": 0,
  "data": [
    { "id":"line001","scene":"morning","text":"早安，今天也要好好补水哦" }
  ]
}
```

## 8. 错误码（示例）
- 0：成功
- 1001：参数错误
- 1002：认证失败或过期
- 2001：资源未找到
- 3001：订单已存在（幂等）
- 3002：支付失败或签名校验失败
- 4001：频率过高（限流）
- 5000：服务器内部错误

## 9. 安全与合规
- 所有接口必须使用 HTTPS；敏感数据加密传输与存储。
- 鉴权中 token 不得出现在 URL；推荐放置于 Authorization Header。
- 用户数据仅为提供服务所需的最小集；支持删除与导出。
- 明确免责声明与健康提示，避免医疗化承诺。
