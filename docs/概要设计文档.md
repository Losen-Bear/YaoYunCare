# “膳韵仙子”小程序 概要设计文档（SSD）

版本：v1.0  
依据：IEEE 1016、微信小程序规范、十二要素应用、OWASP ASVS

## 1. 设计目标
- 清晰的模块边界与可迭代架构：先“模块化单体”，可演进为“微服务/函数计算”。
- 安全、可观测、易部署：内建鉴权、限流、结构化日志与指标。
- 面向数据闭环：埋点与反馈驱动推荐引擎持续优化。

## 2. 整体架构
- 前端：微信小程序（pages/components），统一网络层、状态管理、埋点与错误降级。
- 后端：Python（FastAPI/Flask），分层为 API → Service → Domain → Repository → Infra。
- 数据：关系型数据库（PostgreSQL/MySQL），Redis 缓存与会话，COS/OSS 存储素材。
- 异步：Celery/RQ 承载模型推理与消息通知。
- 部署：Docker 镜像 + Nginx 反向代理 + HTTPS；或 SCF 承载轻量接口。

## 3. 模块划分
- Auth & Membership：微信登录、会话、会员权益与到期。
- Assessment：问卷管理、评分与体质画像计算、版本化。
- Recommendation：规则与打分、禁忌约束、列表与详情。
- Content/CMS：菜谱、素材、活动位管理。
- Payment/Order：下单、支付回调、账单与幂等。
- Analytics：埋点采集、事件汇总、报表接口与 A/B。
- Platform/Infra：缓存、对象存储、队列、配置与审计。

## 4. 关键数据流（文字描述）
1) 登录：wx.login → 后端 jscode2session → 颁发短期 JWT → 存储/刷新会话。  
2) 评估：小程序拉取问卷 → 用户答题 → 后端计算体质与解释 → 返回雷达与建议。  
3) 推荐：后端依据体质与偏好从规则/菜谱库计算适配度 → 返回列表与详情。  
4) 支付：创建订单 → 微信统一下单 → 支付回调 → 幂等更新账单与会员权益。  
5) 埋点：前端统一事件管道 → 后端写日志/指标 → 看板与漏斗展示。  

## 5. 接口与协议
- 基础路径：/api/v1  
- 认证：JWT（短期）+ 刷新；支付与回调使用签名校验。  
- 规范：JSON 请求/响应；错误统一码；分页/排序约定。详见《接口规范文档》。

## 6. 部署拓扑与环境
- dev：本地开发，SQLite/Postgres、MinIO/COS（dev bucket）、Mock 支付。
- staging：预发布，接近生产参数，灰度与压测。
- prod：生产，主从数据库、Redis 高可用、COS 正式桶、按需扩容。

## 7. 安全与合规设计
- 数据最小化与访问控制；敏感字段加密/脱敏；审计日志与风控黑白名单。
- 等保 2.0 参考：账户安全、通信加密、入侵防护、备份恢复、权限分级。
- 明确免责声明：建议仅限科普与饮食指导，非医疗行为。

## 8. 可观测性
- 日志：结构化 JSON，含 traceId/userId/uri/duration。
- 指标：接口耗时、错误率、支付成功率、推荐点击率。
- 告警：阈值 + 自愈降级（静态推荐/缓存回退）。

## 9. 关键设计权衡
- 体质评估先规则后模型：上线速度与可解释性；后续引入模型需保持回滚通道。
- 支付优先闭环稳定：签名与幂等优先级高于复杂功能迭代。
- 单仓库 Monorepo 便于联动与版本治理，必要时拆分为多仓。

## 10. 数据备份与灾备
- 数据库每日全量 + 每小时增量备份；COS 版本化与生命周期策略。
- 跨可用区部署与自动化恢复演练；支付回调与账单具备重放能力。
